# Project Folder Structure Blueprint

**Last updated:** 2026-02-10

This document describes the folder structure and organization conventions for this repository.

## 1. Structural Overview

This is a small TypeScript (ESM) library repo with three distinct areas:

- `src/` and `test/`: runtime library code and Node `node:test` tests (compiled by `tsc` into `dist/`).
- `openspec/`: spec-driven workflow artifacts (proposal/design/specs/tasks) used to drive implementation.
- `.opencode/`: OpenCode workflow definitions (commands + skills) used to run OpenSpec flows.

It is not a monorepo and does not include a frontend.

## 2. Directory Visualization (ASCII)

Generated folders are included but called out explicitly.

```
./
├── AGENTS.md
├── LICENSE
├── README.md
├── Project_Folders_Structure_Blueprint.md
├── package.json
├── package-lock.json
├── tsconfig.json
├── dist/                        # GENERATED: `tsc` output
├── node_modules/                # GENERATED: npm dependencies
├── src/
│   ├── index.ts                 # Public exports (re-exports `src/mcp/*`)
│   └── mcp/
│       ├── AGENTS.md
│       ├── errors.ts
│       ├── gate.ts
│       ├── policy.ts
│       ├── redaction.ts
│       └── types.ts
├── test/
│   ├── AGENTS.md
│   ├── gate.test.ts
│   └── policy.test.ts
├── openspec/
│   ├── AGENTS.md
│   ├── config.yaml              # OpenSpec schema config (spec-driven)
│   ├── specs/                   # Base capability specs (empty in this repo currently)
│   └── changes/
│       ├── archive/             # Archived changes (convention)
│       ├── mcp-elicitation-human-in-loop/
│       └── mcp-human-in-loop/
│           ├── proposal.md
│           ├── design.md
│           ├── tasks.md
│           └── specs/
│               └── mcp-human-in-loop/
│                   └── spec.md
└── .opencode/
    ├── AGENTS.md
    ├── package.json             # Minimal dependency surface for OpenCode
    ├── bun.lock
    ├── node_modules/            # GENERATED: dependencies for OpenCode tooling
    ├── command/                 # Command definitions (markdown)
    └── skills/                  # Skill definitions (markdown)
```

## 3. Key Directory Analysis

### `src/`

Purpose: library source code.

- `src/index.ts` is the public entry point and re-exports from `src/mcp/*`.
- `src/mcp/` contains the MCP human-in-loop gate implementation.

### `test/`

Purpose: unit tests.

- Tests are authored in TypeScript and compiled to `dist/test/`.
- `npm test` runs `tsc` first, then runs Node's test runner against `dist/test`.

### `dist/` (generated)

Purpose: compilation output.

- Generated by `npm run build` (`tsc -p tsconfig.json`).
- Not intended for manual edits.

### `openspec/`

Purpose: OpenSpec artifacts used to drive implementation.

- `openspec/config.yaml` declares schema (currently `spec-driven`).
- `openspec/changes/<change>/` contains:
  - `proposal.md`: why/what
  - `design.md`: decisions + implementation approach
  - `specs/<capability>/spec.md`: requirement scenarios
  - `tasks.md`: checklisted work items used by the apply workflow

### `.opencode/`

Purpose: OpenCode workflows.

- `.opencode/command/*.md`: command specs for the opsx workflow.
- `.opencode/skills/**/SKILL.md`: skill prompt definitions.
- This directory is intended to be documentation/config only; runtime code belongs in `src/`.

## 4. File Placement Patterns

### Runtime/library code

- MCP approval gate code lives under `src/mcp/`.
- Public exports should be re-exported via `src/index.ts`.
- TypeScript import paths in `src/` use `.js` extensions (ESM + emitted JS compatibility).

### Tests

- Put tests in `test/` and name them `*.test.ts`.
- Prefer testing public behavior (policy matching and gate execution) rather than private helpers.

### OpenSpec artifacts

- Add new change work under `openspec/changes/<kebab-case-name>/`.
- Keep `tasks.md` checkbox syntax exactly (`- [ ]` / `- [x]`), since tooling parses it.

## 5. Naming And Organization Conventions

- Folder names: lowercase (`src`, `test`, `openspec`, `.opencode`).
- Change names/capabilities: kebab-case (`mcp-human-in-loop`).
- TypeScript code:
  - ESM (`"type": "module"`), `.js` import specifiers in `.ts`.
  - Strict typechecking; `exactOptionalPropertyTypes` enabled.

## 6. Navigation And Development Workflow

Entry points:

- Library exports: `src/index.ts`.
- Primary gate behavior: `src/mcp/gate.ts`.
- Policy precedence rules: `src/mcp/policy.ts`.
- Argument redaction/truncation: `src/mcp/redaction.ts`.
- OpenSpec change definition: `openspec/changes/mcp-human-in-loop/`.

Common tasks:

- Add a new MCP gating feature: start in `src/mcp/` and expose via `src/index.ts`.
- Add tests: mirror behavior in `test/*.test.ts`.
- Add a new spec-driven change: `openspec new change "<name>"` then fill proposal/design/specs/tasks.

Content statistics (current snapshot):

- Total files (excluding `node_modules/` and `.git/`): 67
- TypeScript LOC across repo (src/test/.opencode/openspec): ~460
- Max directory depth observed: 6

## 7. Build And Output Organization

Build configuration:

- `package.json` scripts:
  - `npm run build` -> `tsc -p tsconfig.json`
  - `npm test` -> build then `node --test dist/test`

Output structure:

- `dist/` mirrors source layout (`dist/src/**`, `dist/test/**`) with `.js` + `.d.ts` + source maps.

## 8. Technology-Specific Organization (Node.js/TypeScript)

- ESM package with explicit `exports` mapping (`dist/index.js` and `dist/index.d.ts`).
- Node built-in test runner (`node:test`) is used; typings provided via `@types/node`.

## 9. Extension And Evolution

Extension points:

- Inject runtime dependencies into the gate via options (`handraise`, `logger`, `randomUUID`, `nowMs`, `summarize`) rather than importing platform-specific modules.
- Keep public contracts stable in `src/mcp/types.ts`; treat changes as breaking unless backwards-compatible.

Refactoring guidance:

- Prefer small changes scoped to `src/mcp/*` and corresponding `test/*` updates.
- Avoid moving OpenSpec/OpenCode workflow files unless adjusting the workflow itself.

## 10. Templates

### New MCP module

Add `src/mcp/<name>.ts`, export from `src/index.ts`, and add tests under `test/`.

### New test

Create `test/<area>.test.ts` using `node:test` + `node:assert/strict`.

### New spec-driven change

```
openspec new change "<kebab-case-name>"
openspec status --change "<kebab-case-name>"
```

Then fill `proposal.md`, `design.md`, `specs/<capability>/spec.md`, and `tasks.md`.

## 11. Structure Enforcement

- TypeScript compiler settings in `tsconfig.json` enforce strict typing and exact optional semantics.
- Tests must pass via `npm test` before considering a change complete.
- `dist/` and `node_modules/` are generated; avoid manual edits.
